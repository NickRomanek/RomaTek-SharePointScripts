# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) Connect interactively (app registration needs Group.Read.All)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$adminUrl = "https://romanteks-admin.sharepoint.com"
$clientId = "f135dcd8-4464-4891-9b47-e8327719b434"

Connect-PnPOnline -Url $adminUrl -ClientId $clientId -Interactive

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) Get Microsoftâ€¯Graph token
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$token = Get-PnPAccessToken -ResourceTypeName Graph

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) Helper â€“ returns Public | Private | HiddenMembership
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Get-GroupVisibilityFromGraph {
    param (
        [Parameter(Mandatory)][string]$GroupId,
        [Parameter(Mandatory)][string]$Token
    )

    $uri     = "https://graph.microsoft.com/v1.0/groups/$GroupId"
    $headers = @{ Authorization = "Bearer $Token" }

    try {
        (Invoke-RestMethod -Uri $uri -Headers $headers -Method GET).visibility
    }
    catch {
        Write-Warning ("âš ï¸  Could not get visibility for {0}: {1}" -f $GroupId, $_.Exception.Message)
        return "Unknown"
    }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) Enumerate sites â€“ show Visibility + SharingCapability
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$sites = Get-PnPTenantSite

foreach ($site in $sites) {

    # â†’ Group visibility colourâ€‘coding (modern sites)
    if ($site.GroupId -ne [Guid]::Empty) {
        $visibility = Get-GroupVisibilityFromGraph -GroupId $site.GroupId -Token $token

        switch ($visibility) {
            'Public'  { Write-Host "ğŸ” Site: $($site.Url) | Group Visibility: $visibility" -ForegroundColor Red }
            'Private' { Write-Host "ğŸ” Site: $($site.Url) | Group Visibility: $visibility" -ForegroundColor Green }
            default   { Write-Host "ğŸ” Site: $($site.Url) | Group Visibility: $visibility" }
        }
    }
    else {
        Write-Host "ğŸ› Classic Site: $($site.Url) (No Microsoftâ€¯365 Group)"
    }

    # â†’ Externalâ€‘sharing colourâ€‘coding
    switch ($site.SharingCapability) {
        'ExternalUserAndGuestSharing' {
            Write-Host "ğŸŒ Sharing: $($site.SharingCapability)" -ForegroundColor Red
        }
        'ExternalUserSharingOnly' {
            Write-Host "ğŸŒ Sharing: $($site.SharingCapability)" -ForegroundColor Yellow
        }
        default {
            Write-Host "ğŸŒ Sharing: $($site.SharingCapability)"
        }
    }

    Write-Host ""  # blank line between sites
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) Optional CSV export block â€“ uncomment if needed
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<# 
$report = foreach ($site in $sites) {
    [pscustomobject]@{
        Url              = $site.Url
        SharingCapability= $site.SharingCapability
        GroupVisibility  = if ($site.GroupId -ne [Guid]::Empty) {
                               Get-GroupVisibilityFromGraph -GroupId $site.GroupId -Token $token
                           } else { 'Classic' }
    }
}
$report | Export-Csv -NoTypeInformation .\SiteVisibilityAndSharing.csv
#>
